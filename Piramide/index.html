<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piramide</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.2.0/p5.js"
        integrity="sha512-cuCpFhuSthtmbmQ5JjvU7msRYynRI67jVHsQhTP8RY+H4BC9qa9kQJeHTomV9/QnOWJbDpLFKdbIHtqTomJJug=="
        crossorigin="anonymous"></script>

    <script src="Piramide/Grid"></script>
    <script src="Piramide/GameCreation"></script>
    <script src="Piramide/Interaction"></script>


</head>

<body onunload="">

    <center>
        <h1 id="title">Piramide</h1>
    </center>

</body>

<script>

    var window_height = window.innerHeight;
    var window_width = window.innerWidth;

    //REGOLE DEL GIOCO
    var N = 6; //numero di righe e colonne
    var rows = N;
    var GAME = false;//DIVENTA TRUE QUANDO VIENE CREATO IL GIOCO
    var max_iterations = 50000;
    var side_length = (window_width) / 10;//lunghezza del lato della cella
    var clr = 255//colore di una cella di default
    var cnvx = 0;
    var cnvy = 80;
    var dimCanvas_x = window_width - cnvx;
    var dimCanvas_y = window_height - cnvy;
    const back_color = 255;
    var rectangle;

    const NUM_SIZE = side_length / 1.7;//size of numbers
    const NUM_CLUES = N + 1;//number of clues showed

    //INTERACTION
    const el_side = side_length * 0.8
    const yElements = (4 + N) * side_length;
    const sizeButton = 1.3 * side_length;
    let RemoveButton;
    let BackButton;

    let to_load_data = null;

    function setup() {

        cnv = createCanvas(dimCanvas_x, dimCanvas_y);
        cnv.id('canvas');
        cnv.position(cnvx, cnvy);
        canv = document.getElementById('canvas')
        rectangle = canv.getBoundingClientRect();

        var button_newGame = createButton('new Game');
        button_newGame.addClass('newGame');
        button_newGame.position(window_width - 90, cnvy);

        document.querySelector('.newGame').addEventListener('click', () => {

            CreateNewGame();

        });

        var button_Help = createButton('Help');
        button_Help.addClass('Help');
        button_Help.position(10, cnvy);

        document.querySelector('.Help').addEventListener('click', () => {

            GiveHelp();
            ShowGrid();

        });

        background(back_color);

        RemoveButton = new ButtonRubbish(window_width - sizeButton - side_length, yElements + 2*side_length, sizeButton);
        RemoveButton.show();

        BackButton = new ButtonBack(sizeButton + side_length, yElements + 2 * side_length, sizeButton);
        BackButton.show();


        CreateGrid()
        CreateElements();

        CreateGame();
        AddClues();

        ShowGrid();
        ShowElements();

        document.querySelector('#canvas').addEventListener('click', (event) => {

            CheckElements();
            CheckGrid();
            CheckRemove();
            RemoveValue();
            Back();

            background(back_color);
            ShowGrid();
            ShowElements();
            RemoveButton.show();
            BackButton.show();
        
        })

    }

    function CreateNewGame(){

        selected_Element = null;
        waitRemove = false;
        FilledCells = [];

        background(back_color);

        ResetGrid();
        ResetElements();

        CreateGame();
        AddClues()
        ShowGrid();
        RemoveButton.show();
        BackButton.show();
        ShowElements();

    }

    function Remove(arr, el){

        let toRemove_index = null;

        for(let i = 0; i < arr.length; i++){
            if(arr[i] == el){
                toRemove_index = i;
            }
        }

        let aux = arr[arr.length - 1];
        arr[arr.length - 1] = el;
        arr[toRemove_index] = aux;

        arr.pop();
    }

    async function get_data(){

        const options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        };
        const path = window.location.href + '/get_data'
        const res = await fetch(path, options);
        to_load_data = await res.json()

        console.log(to_load_data);
    }

    async function send_data() {

        grid_for_json = {
            grid: [],
            cluegrid: []
        }

        for (let i = 0; i < rows; i++) {
            grid_for_json.grid.push([])
            for (let j = 0; j < cols; j++) {
                cell = grid[i][j]
                new_cell = {
                    i: cell.i,
                    j: cell.j,
                    value: cell.value,
                    show: cell.show,
                    color: cell.color
                }
                grid_for_json.grid[i].push(new_cell)
            }
        }

        for (let i = 0; i < 4; i++) {
            grid_for_json.cluegrid.push([])
            for (let j = 0; j < N; j++) {
                cell = CluesGrid[i][j];
                grid_for_json.cluegrid[i].push(cell.clue)
            }
        }

        console.log(grid_for_json)
        const options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(grid_for_json)
        };

        const path = window.location.href + '/data'
        const res2 = await fetch(path, options);
    }

</script>

</html>